<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Document</title>
  </head>
  <body style="position: relative">
    <svg height="500" width="500">
      <defs>
        <marker
          id="edge-end"
          markerWidth="8"
          markerHeight="8"
          refX="0"
          refY="4"
          orient="auto"
          cursor="grab"
          style="cursor: grab"
          markerUnits="userSpaceOnUse"
        >
          <polygon points="0 0, 8 4, 0 8" />
        </marker>
      </defs>
      <g transform="translate(0.5, 0.5)">
        <path
          id="p-handle"
          fill="none"
          stroke="aqua"
          stroke-width="5"
          stroke-linejoin="bevel"
          d="M 10 100 L 15 100 L 15 120 L 135 120 L 135 100 L 140 100"
        ></path>
        <path
          id="p"
          fill="none"
          stroke="black"
          stroke-width="1"
          stroke-linejoin="round"
          d="M 10 100 L 15 100 L 15 120 L 135 120 L 135 100 L 140 100"
          pointer-events="none"
        ></path>
        <path
          id="arrow-end"
          d="M 140 95 L 150 100 L 140 105"
          fill="red"
          draggable="true"
          cursor="grab"
        ></path>
      </g>
    </svg>
    <div
      id="div1"
      style="
        position: absolute;
        height: 200px;
        width: 200px;
        background-color: blue;
        top: 1000px;
      "
    ></div>
    <div
      id="div2"
      style="
        pointer-events: none;
        position: absolute;
        height: 100px;
        width: 100px;
        background-color: red;
        top: 1000px;
      "
    ></div>
    <script>
      function edge(x1, y1, x2, y2, e) {
        let x = e.offsetX;
        let y = e.offsetY;
        let xMin = x1;
        let xMax = x2;
        let yMin = y1;
        let yMax = y2;
        if (x1 > x2) {
          xMin = x2;
          xMax = x1;
        }
        if (y1 > y2) {
          yMin = y2;
          yMax = y1;
        }
        // vertical
        if (x1 === x2) {
          // if (x === x1 && y < yMax && y > yMin) {
          //   return 'vertical';
          // }
          if (Math.abs(x - x1) < 5 && y < yMax && y > yMin) {
            return 'vertical';
          }
          // horizontal
        } else if (y1 === y2) {
          // if (y === y1 && x < xMax && x > xMin) {
          //   return 'horizontal';
          // }
          if (Math.abs(y - y1) < 5 && x < xMax && x > xMin) {
            return 'horizontal';
          }
        }
      }
      let path = document.getElementById('p');
      let handle = document.getElementById('p-handle');
      let arrowEnd = document.getElementById('arrow-end');

      arrowEnd.addEventListener('mousedown', (e) => {});
      let x;
      let y;
      document.onmouseup = (e) => {
        console.log('mouseup');
        document.onmousemove = null;
      };
      handle.addEventListener('mousedown', (e) => {
        x = e.offsetX;
        y = e.offsetY;
        let ret;
        let d = handle
          .getAttribute('d')
          .split(' ')
          .filter((v) => {
            return /\d/.test(v);
          });
        console.log(d);
        for (let i = 0; i < d.length && d[i + 3]; i += 2) {
          ret = edge(
            parseInt(d[i]),
            parseInt(d[i + 1]),
            parseInt(d[i + 2]),
            parseInt(d[i + 3]),
            e,
          );

          if (ret === 'vertical') {
            d[i] = '$';
            d[i + 2] = '$';
            break;
          } else if (ret === 'horizontal') {
            d[i + 1] = '$';
            d[i + 3] = '$';
            break;
          }
        }
        console.log(d.join(' '));
        let newD = [];
        for (let i = 0; i < d.length; i++) {
          newD.push(d[i]);
          if (i !== 0 && i !== d.length - 1 && i % 2 === 1) {
            newD.push('L');
          }
        }
        console.log('M ' + newD.join(' '));
        let temp = 'M ' + newD.join(' ');

        document.onmousemove = (e) => {
          console.log(temp);
          if (ret === 'vertical') {
            path.setAttribute('d', temp.replace(/\$/g, x));
            handle.setAttribute('d', temp.replace(/\$/g, x));
          } else if (ret === 'horizontal') {
            path.setAttribute('d', temp.replace(/\$/g, y));
            handle.setAttribute('d', temp.replace(/\$/g, y));
          }
          x = e.offsetX;
          y = e.offsetY;
          document.body.style.userSelect = 'none';
        };
      });
      let div1 = document.getElementById('div1');
      div1.addEventListener('click', () => {
        console.log('div1 clicked');
      });
    </script>
  </body>
</html>
